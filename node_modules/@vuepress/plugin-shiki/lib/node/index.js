import{Logger as P,getModulePath as c,isModuleAvailable as N}from"@vuepress/helper";import{resolveWhitespacePosition as C,lineNumbers as H,collapsedLines as W}from"@vuepress/highlighter-helper";import{isPlainObject as v}from"vuepress/shared";import{colors as f}from"vuepress/utils";import{customAlphabet as x}from"nanoid";import{createRequire as E}from"node:module";import{createHighlighter as M,isSpecialLang as F}from"shiki";import{createSyncFn as j}from"synckit";import{transformerNotationDiff as S,transformerNotationFocus as O,transformerNotationHighlight as q,transformerNotationErrorLevel as D,transformerNotationWordHighlight as R,transformerMetaWordHighlight as _,transformerRenderWhitespace as G,transformerCompactLineOptions as I}from"@shikijs/transformers";const U=t=>{const e={},r=t.render.bind(t);return t.render=(s,n={})=>(e.path=n.filePathRelative,r(s,n)),()=>e.path||"dynamic pages"},z=/\[\\!code/g,B={name:"vuepress:add-class",pre(t){this.addClassToHast(t,"vp-code")}},J={name:"vuepress:cleanup",pre(t){delete t.properties.tabindex}},K={name:"vuepress:remove-escape",postprocess(t){return t.replace(z,"[!code")}},Q={name:"vuepress:empty-line",code(t){t.children.forEach(e=>{e.type==="element"&&e.tagName==="span"&&Array.isArray(e.properties.class)&&e.properties.class.includes("line")&&e.children.length===0&&e.children.push({type:"element",tagName:"wbr",properties:{},children:[]})})}},V={name:"vuepress:v-pre",pre(t){t.properties["v-pre"]=""}},X=/-vue$/,y="@vuepress/plugin-shiki",w=new P(y),Y=x("abcdefghijklmnopqrstuvwxyz",10),$=t=>t.match(/^([^ :[{]+)/)?.[1]?.replace(X,"").toLowerCase()??"",Z=(t,e)=>{const r=`\\b${e}\\s*=\\s*(?<quote>['"])(?<content>.+?)\\k<quote>(\\s|$)`,s=new RegExp(r,"i");return t.match(s)?.groups?.content??null},ee=t=>{const e=t.replace(/^(?:\[.*?\])?.*?([\d,-]+).*/,"$1").trim(),r=[];return e?(e.split(",").map(s=>s.split("-").map(n=>parseInt(n,10))).forEach(([s,n])=>{s&&n?r.push(...Array.from({length:n-s+1},(i,l)=>s+l)):r.push(s)}),r.map(s=>({line:s,classes:["highlighted"]}))):[]},te=E(import.meta.url),se=j(te.resolve("@vuepress/plugin-shiki/resolveLang")),re=async(t,{langs:e=[],langAlias:r={},defaultLang:s,shikiSetup:n,...i}={},l=!0)=>{const o=await M({langs:[...e,...Object.values(r)],langAlias:r,themes:"themes"in i?Object.values(i.themes):[i.theme??"nord"]}),h=a=>{if(F(a))return!0;if(!o.getLoadedLanguages().includes(a)){const p=se(a);if(!p.length)return!1;o.loadLanguageSync(p)}return!0},g=o.getLanguage;o.getLanguage=a=>{const p=typeof a=="string"?a:a.name;return h($(p)),g.call(o,a)};const u=[];if(l&&u.push(V),i.twoslash){const{createTwoslashTransformer:a,createFileSystemTypesCache:p}=await import("@vuepress/shiki-twoslash"),{typesCache:m,...d}=v(i.twoslash)?i.twoslash:{};u.push(await a({...d,typesCache:m===!0||typeof m>"u"?p({dir:t.dir.cache("markdown/twoslash")}):m}))}return await n?.(o),{highlighter:o,loadLang:h,extraTransformers:u}},ie=t=>{const e=[];return t.notationDiff&&e.push(S({matchAlgorithm:"v3"})),t.notationFocus&&e.push(O({classActiveLine:"has-focus",classActivePre:"has-focused-lines",matchAlgorithm:"v3"})),t.notationHighlight&&e.push(q({matchAlgorithm:"v3"})),t.notationErrorLevel&&e.push(D({matchAlgorithm:"v3"})),t.notationWordHighlight&&(e.push(R({matchAlgorithm:"v3"})),e.push(_())),e.push(B,J,K,Q),e},ne=(t,e=!1)=>{const r=C(t,e);return r===!1?[]:[G({position:r})]},L=new Set,ae=(t,{defaultLang:e,logLevel:r},s,n)=>{let i=$(t);return i&&!s(i)&&(r!=="silent"&&!L.has(i)&&(w.warn(`Missing ${f.cyan(t)} highlighter, ${e?`use ${f.cyan(e)} to highlight instead.`:"skip highlighting"}`),L.add(i)),r==="debug"&&w.info(`Unknown language ${f.cyan(i)} found in ${f.cyan(n())}`),i=e||"plain"),i},oe=/\{\{[^]*?\}\}/g,le=(t,e)=>t.replace(oe,r=>{let s=e.get(r);return s||(s=Y(),e.set(r,s)),s}),he=(t,e)=>{let r=t;return e.forEach((s,n)=>{r=r.replaceAll(s,n)}),r},pe=(t,e)=>{const r=new Map;return he(e(le(t,r).trimEnd()),r)},ce=(t,e,r,s,n)=>{const i=ie(e);return(l,o,h)=>pe(l,g=>t.codeToHtml(g,{lang:ae(o,e,s,n),meta:{__raw:h},transformers:[...i,...e.highlightLines??!0?[I(ee(h))]:[],...ne(h,e.whitespace),...r??[],...e.transformers??[]],..."themes"in e?{themes:e.themes,defaultColor:!1}:{theme:e.theme??"nord"}}))},b=/{([\d,-]+)}/,ue=t=>{const e=t.renderer.rules.fence;t.renderer.rules.fence=(...r)=>{const[s,n]=r,i=s[n],l=i.info||"",o=l.match(b);if(!o)return e(...r);i.info=l.replace(b,"").trim();const h=o[1];return i.info+=` ${h}`,e(...r)}},me=/<pre([\s\S]*?)style="([^"]*)"([^>]*)>/,ge=(t,{preWrapper:e=!0}={})=>{const r=t.renderer.rules.fence;t.renderer.rules.fence=(...s)=>{let n=r(...s);if(!n.startsWith("<pre"))return n;const[i,l,o]=s,h=i[l],g=h.info?t.utils.unescapeAll(h.info).trim():"",u=$(g),a=`${o.langPrefix}${u}`;if(!e)return n=n.replace(/<code[^]*?>/,"<code>"),n=`<pre class="${a}"${n.slice(4)}`,n;const p=Z(g,"title")||u;let m="";return n=n.replace(me,(d,k,T,A)=>(m=T.trim(),`<pre ${k.trim()}${A.trimEnd()}>`)),`<div class="${a}" data-highlighter="shiki" data-ext="${u}" data-title="${p}" style="${m}">${n}</div>`}},de=(t,{lineNumbers:e=!0,highlightLines:r=!0,collapsedLines:s="disable",notationDiff:n,notationErrorLevel:i,notationFocus:l,notationHighlight:o,notationWordHighlight:h,whitespace:g,twoslash:u})=>{const a=[`import "${c("@vuepress/highlighter-helper/styles/base.css",import.meta)}"`,`import "${c(`${y}/styles/shiki.css`,import.meta)}"`],p=[],m=[];e!=="disable"&&a.push(`import "${c("@vuepress/highlighter-helper/styles/line-numbers.css",import.meta)}"`),(r||o)&&a.push(`import "${c("@vuepress/highlighter-helper/styles/notation-highlight.css",import.meta)}"`),n&&a.push(`import "${c("@vuepress/highlighter-helper/styles/notation-diff.css",import.meta)}"`),i&&a.push(`import "${c("@vuepress/highlighter-helper/styles/notation-error-level.css",import.meta)}"`),l&&a.push(`import "${c("@vuepress/highlighter-helper/styles/notation-focus.css",import.meta)}"`),o&&a.push(`import "${c("@vuepress/highlighter-helper/styles/notation-highlight.css",import.meta)}"`),h&&a.push(`import "${c("@vuepress/highlighter-helper/styles/notation-word-highlight.css",import.meta)}"`),g&&a.push(`import "${c("@vuepress/highlighter-helper/styles/whitespace.css",import.meta)}"`),s!=="disable"&&(a.push(`import "${c("@vuepress/highlighter-helper/styles/collapsed-lines.css",import.meta)}"`,`import { setupCollapsedLines } from "${c("@vuepress/highlighter-helper/client",import.meta)}"`),m.push("setupCollapsedLines()")),u&&(a.push(`import { enhanceTwoslash } from "${c("@vuepress/shiki-twoslash/client",import.meta)}"`),a.push(`import "${c("@vuepress/shiki-twoslash/styles/twoslash.css",import.meta)}"`),p.push("enhanceTwoslash(app)"));let d=a.join(`
`);return(m.length||p.length)&&(d+=`
export default {
`,p.length&&(d+=`  enhance({ app }) {
    ${p.join(`
    `)}
  },
`),m.length&&(d+=`  setup() {
    ${m.join(`
    `)}
  },
`),d+=`}
`),t.writeTemp("shiki/config.js",d)},fe=(t={})=>e=>{const{code:r}=e.options.markdown,s={...v(r)?r:{},...t};s.logLevel??=e.env.isDebug?"debug":"warn",s.preWrapper??=!0,s.lineNumbers??=!0,s.collapsedLines??="disable",s.twoslash&&!N("@vuepress/shiki-twoslash",import.meta)&&(w.error(`${f.cyan("twoslash")} is enabled, but ${f.magenta("@vuepress/shiki-twoslash")} is not installed, please install it manually`),s.twoslash=!1);let n=!0;return{name:"@vuepress/plugin-shiki",extendsMarkdownOptions:i=>{if(i.vPre!==!1){const l=v(i.vPre)?i.vPre:{block:!0};l.block&&(i.vPre??={},i.vPre.block=!1),n=l.block??!0}else n=!1},extendsMarkdown:async i=>{const{preWrapper:l,lineNumbers:o,collapsedLines:h}=s,g=U(i),{highlighter:u,loadLang:a,extraTransformers:p}=await re(e,s,n);i.options.highlight=ce(u,s,p,a,g),i.use(ue),i.use(ge,{preWrapper:l}),l&&(i.use(H,{lineNumbers:o}),i.use(W,{collapsedLines:h}))},clientConfigFile:()=>de(e,s)}};export{fe as shikiPlugin};
//# sourceMappingURL=index.js.map
